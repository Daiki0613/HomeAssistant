blueprint:
  name: Philips Tap Dial (Zigbee2MQTT)
  description: >
    Control up to four lights with the Philips Hue Tap Dial (Zigbee2MQTT).
    Each of the four buttons toggles its own light target.
    The dial adjusts the brightness of the most recently toggled light
    (tracked with an optional input_text helper).

  domain: automation

  input:
    button_sensor:
      name: Tap Dial action sensor
      description: >
        Sensor entity for the Tap Dial from Zigbee2MQTT
        (typically something like sensor.<name>_action).
      selector:
        entity:
          domain:
            - sensor

    first_light:
      name: First light (button 1)
      description: Light(s) toggled by button 1
      selector:
        target:
          entity:
            domain:
              - light

    second_light:
      name: Second light (button 2 – optional)
      description: Light(s) toggled by button 2
      default: {}
      selector:
        target:
          entity:
            domain:
              - light

    third_light:
      name: Third light (button 3 – optional)
      description: Light(s) toggled by button 3
      default: {}
      selector:
        target:
          entity:
            domain:
              - light

    forth_light:
      name: Fourth light (button 4 – optional)
      description: Light(s) toggled by button 4
      default: {}
      selector:
        target:
          entity:
            domain:
              - light

    current_light:
      name: Current light helper (optional)
      description: >
        input_text helper used to remember which light should be dimmed
        with the dial (stores "first_light", "second_light", etc.).
        If left empty, the dial always controls the first light.
      default:
      selector:
        entity:
          domain:
            - input_text
          multiple: false

    dim_scale:
      name: Dimming scale
      description: >
        Base scale for dimming. The dial actions will use this as step size,
        with larger values dimming/brighting faster.
      default: 3.0
      selector:
        number:
          min: 0.0
          max: 5.0
          step: 0.01
          mode: slider

    dim_time:
      name: Dimming transition time
      description: >
        Transition time (in seconds) for each dim step.
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 1.0
          step: 0.01
          mode: slider

mode: restart
max_exceeded: silent

variables:
  first_light: !input first_light
  second_light: !input second_light
  third_light: !input third_light
  forth_light: !input forth_light
  current_light: !input current_light
  dim_scale: !input dim_scale
  dim_time: !input dim_time

  # Map helper value -> actual target
  light_targets:
    first_light: !input first_light
    second_light: !input second_light
    third_light: !input third_light
    forth_light: !input forth_light

trigger:
  # Button presses
  - platform: state
    entity_id: !input button_sensor
    to: button_1_press
  - platform: state
    entity_id: !input button_sensor
    to: button_2_press
  - platform: state
    entity_id: !input button_sensor
    to: button_3_press
  - platform: state
    entity_id: !input button_sensor
    to: button_4_press

  # Dial rotations
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_left_step
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_left_slow
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_left_fast
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_right_step
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_right_slow
  - platform: state
    entity_id: !input button_sensor
    to: dial_rotate_right_fast

action:
  - variables:
      action: "{{ trigger.to_state.state }}"

  - choose:
      # ── Button 1 toggles first_light ──
      - conditions: "{{ action == 'button_1_press' }}"
        sequence:
          - service: light.toggle
            target: !input first_light
          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input current_light
                    data:
                      value: first_light

      # ── Button 2 toggles second_light (if set) ──
      - conditions:
          - "{{ action == 'button_2_press' }}"
          - "{{ second_light is not none }}"
        sequence:
          - service: light.toggle
            target: !input second_light
          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input current_light
                    data:
                      value: second_light

      # ── Button 3 toggles third_light (if set) ──
      - conditions:
          - "{{ action == 'button_3_press' }}"
          - "{{ third_light is not none }}"
        sequence:
          - service: light.toggle
            target: !input third_light
          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input current_light
                    data:
                      value: third_light

      # ── Button 4 toggles forth_light (if set) ──
      - conditions:
          - "{{ action == 'button_4_press' }}"
          - "{{ forth_light is not none }}"
        sequence:
          - service: light.toggle
            target: !input forth_light
          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input current_light
                    data:
                      value: forth_light

      # ── Dial left: dim current light ──
      - conditions:
          - "{{ action in ['dial_rotate_left_step', 'dial_rotate_left_slow', 'dial_rotate_left_fast'] }}"
        sequence:
          - variables:
              # factor based on speed: step (1x), slow (2x), fast (5x)
              factor: >-
                {% if action == 'dial_rotate_left_step' %}
                  1
                {% elif action == 'dial_rotate_left_slow' %}
                  2
                {% else %}
                  5
                {% endif %}
              step_value: "{{ -1 * dim_scale * factor }}"

          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: light.turn_on
                    target: "{{ light_targets[states(current_light)] }}"
                    data:
                      brightness_step_pct: "{{ step_value }}"
                      transition: "{{ dim_time }}"
            default:
              - service: light.turn_on
                target: !input first_light
                data:
                  brightness_step_pct: "{{ step_value }}"
                  transition: "{{ dim_time }}"

      # ── Dial right: brighten current light ──
      - conditions:
          - "{{ action in ['dial_rotate_right_step', 'dial_rotate_right_slow', 'dial_rotate_right_fast'] }}"
        sequence:
          - variables:
              factor: >-
                {% if action == 'dial_rotate_right_step' %}
                  1
                {% elif action == 'dial_rotate_right_slow' %}
                  2
                {% else %}
                  5
                {% endif %}
              step_value: "{{ dim_scale * factor }}"

          - choose:
              - conditions: "{{ current_light != none }}"
                sequence:
                  - service: light.turn_on
                    target: "{{ light_targets[states(current_light)] }}"
                    data:
                      brightness_step_pct: "{{ step_value }}"
                      transition: "{{ dim_time }}"
            default:
              - service: light.turn_on
                target: !input first_light
                data:
                  brightness_step_pct: "{{ step_value }}"
                  transition: "{{ dim_time }}"
